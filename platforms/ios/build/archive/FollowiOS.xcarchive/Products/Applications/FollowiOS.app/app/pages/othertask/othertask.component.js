"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var router_1 = require("@angular/router");
var core_1 = require("@angular/core");
var observable_array_1 = require("tns-core-modules/data/observable-array");
var listviewitems_1 = require("../../service/listviewitems");
var timerModule = require("tns-core-modules/timer");
var firebase = require("nativescript-plugin-firebase");
var application_settings_1 = require("application-settings");
var page_1 = require("ui/page");
var http_post_services_1 = require("../../service/http-post.services");
var OtherTaskComponent = (function () {
    function OtherTaskComponent(router, page, myPostService) {
        var _this = this;
        this.router = router;
        this.page = page;
        this.myPostService = myPostService;
        this.dataItems = new observable_array_1.ObservableArray([]);
        this.detailedDataItems = new observable_array_1.ObservableArray([]);
        this.listViewItems = new listviewitems_1.ListViewItems;
        this.showDetailedView = "collapse";
        this.pageTitle = "Other Task";
        firebase.getCurrentPushToken().then(function (token) {
            // may be null if not known yet
            // alert("Current push token: " + token);
            _this.deviceFCMId = token;
        });
    }
    OtherTaskComponent.prototype.ngOnInit = function () {
        this.dataItems = this.listViewItems.getOtherTaskDetails();
    };
    OtherTaskComponent.prototype.onSwipeCellStarted = function (args) {
        var swipeLimits = args.data.swipeLimits;
        var swipeView = args['object'];
        var leftItem = swipeView.getViewById('emptyView');
        var rightItem = swipeView.getViewById('deleteView');
        //swipeLimits.left = leftItem.getMeasuredWidth();
        swipeLimits.left = 0;
        swipeLimits.right = rightItem.getMeasuredWidth();
        // swipeLimits.right = 0;
        swipeLimits.threshold = leftItem.getMeasuredWidth() / 2;
    };
    OtherTaskComponent.prototype.onPullToRefreshInitiated = function (args) {
        this.dataItems = this.listViewItems.getOtherTaskDetails();
        timerModule.setTimeout(function () {
            var listView = args.object;
            listView.notifyPullToRefreshFinished();
        }, 1000);
    };
    OtherTaskComponent.prototype.deleteTask = function (args) {
        var tapIndex = this.dataItems.indexOf(args.object.bindingContext);
        console.log("Item Kay======" + this.dataItems.getItem(tapIndex).key);
        console.log("Task Name======" + this.dataItems.getItem(tapIndex).taskName);
        var createdByNumber = this.dataItems.getItem(tapIndex).createdByNumber;
        //var key=this.dataItems.getItem(tapIndex).key;
        var itemKey = this.dataItems.getItem(tapIndex).key;
        var devicePhoneNumber = application_settings_1.getString("devicePhoneNumber");
        var x = this;
        var onQueryEvent = function (result) {
            console.log("Delete My task");
            if (!result.error) {
                console.log("IF");
                var resultJson = result.value;
                var assigneeDeviceToken = void 0;
                var taskName = void 0;
                var createdByName = void 0;
                console.log("Result==" + resultJson);
                for (var key1 in resultJson) {
                    console.log("Assignee Number" + key1);
                    if (key1 == null || key1 == "null") { }
                    else {
                        //assigneeDeviceToken=resultJson[key1]["deviceToken"];
                        //taskName=resultJson[key1]["taskName"];
                        //createdByName=resultJson[key1]["createdBy"];
                        //console.log("assigneeDeviceToken===="+assigneeDeviceToken);
                        //delete the task in my task details
                        firebase.remove('/MyTaskDetails/' + key1 + '/' + itemKey).then(function (res) {
                            console.log("Task has been deleted successfully in My task details---");
                            // x.sendPushNotificationForDeletion(assigneeDeviceToken,taskName,createdByName);
                        }, function (res) {
                            console.log("Problem in deleting My task details---" + res);
                        });
                    }
                }
                x.deleteOtherTask(devicePhoneNumber, tapIndex, itemKey);
                for (var key1 in resultJson) {
                    if (key1 == null || key1 == "null") { }
                    else {
                        assigneeDeviceToken = resultJson[key1]["deviceToken"];
                        taskName = resultJson[key1]["taskName"];
                        createdByName = resultJson[key1]["createdBy"];
                        console.log("assigneeDeviceToken====" + assigneeDeviceToken);
                        x.sendPushNotificationForDeletion(assigneeDeviceToken, taskName, createdByName);
                    }
                }
            }
        };
        firebase.query(onQueryEvent, '/OtherTaskDetails/' + devicePhoneNumber + '/' + itemKey + '/AssigneeDetails', {
            singleEvent: true,
            orderBy: {
                type: firebase.QueryOrderByType.KEY,
            },
        });
        timerModule.setTimeout(function () {
            x.dataItems = x.listViewItems.getOtherTaskDetails();
        }, 1000);
    };
    OtherTaskComponent.prototype.deleteOtherTask = function (devicePhoneNumber, tapIndex, itemKey) {
        //delete task in other task details page
        firebase.remove('/OtherTaskDetails/' + devicePhoneNumber + '/' + itemKey).then(function (res) {
            console.log("Task has been deleted successfully in other task details---");
        }, function (res) {
            console.log("Problem in deleting other task details---" + res);
        });
    };
    OtherTaskComponent.prototype.cancel = function () {
        this.showDetailedView = "collapse";
    };
    OtherTaskComponent.prototype.getRemainderCountAndUpdate = function (number, cStatus, rCount) {
        var devicePhoneNumber = application_settings_1.getString("devicePhoneNumber");
        firebase.update('/MyTaskDetails/' + number + '/' + this.tappedItemKey, {
            'remainderCount': rCount + 1,
        });
        firebase.update('/OtherTaskDetails/' + devicePhoneNumber + '/' + this.tappedItemKey + '/AssigneeDetails/' + number, {
            'remainderCount': rCount + 1,
        });
    };
    OtherTaskComponent.prototype.sendPushNotification = function (deviceToken, taskName, createdByName) {
        //send push notification
        var data = {
            "notification": {
                "title": "Reminder!",
                "body": "Reminder sent by " + createdByName + " for " + taskName,
                "priority": "high"
            },
            "to": deviceToken
        };
        console.log("data==" + JSON.stringify(data));
        this.myPostService
            .postData(data).subscribe(function (res) {
            console.log("Reminder Success");
        }, function (error) {
            console.log("Reminder Failure===" + error);
        });
    };
    OtherTaskComponent.prototype.sendPushNotificationForDeletion = function (assigneeDeviceToken, taskName, createdByName) {
        //send push notification
        var data = {
            "notification": {
                "title": "Task Removed!",
                "body": createdByName + " has removed the " + taskName,
                "priority": "high"
            },
            "to": assigneeDeviceToken
        };
        console.log("data==" + JSON.stringify(data));
        this.myPostService
            .postData(data).subscribe(function (res) {
            console.log("Reminder Success");
        }, function (error) {
            console.log("Reminder Failure===" + error);
        });
    };
    OtherTaskComponent.prototype.sendReminder = function () {
        console.log("tappedItemKey===" + this.tappedItemKey);
        var tappedItemKey = this.tappedItemKey;
        var reminderSendDetails = new observable_array_1.ObservableArray([]);
        var x = this;
        var devicePhoneNumber = application_settings_1.getString("devicePhoneNumber");
        console.log("Length===" + this.detailedDataItems.length);
        for (var i = 0; i < this.detailedDataItems.length; i++) {
            var number = this.detailedDataItems.getItem(i).assigneeNumber;
            var cStatus = this.detailedDataItems.getItem(i).completionStatus;
            var rCount = this.detailedDataItems.getItem(i).remainderCount;
            var deviceToken = this.detailedDataItems.getItem(i).deviceToken;
            var taskName = this.detailedDataItems.getItem(i).taskName;
            var createdByName = this.detailedDataItems.getItem(i).createdBy;
            console.log("Number====" + number);
            console.log("cStatus====" + cStatus);
            console.log("rCount====" + rCount);
            console.log("Device Token====" + deviceToken);
            console.log("Task Name====" + taskName);
            console.log("Created By====" + createdByName);
            if (!cStatus)
                this.getRemainderCountAndUpdate(number, cStatus, rCount);
            this.sendPushNotification(deviceToken, taskName, createdByName);
        }
        var onQueryEvent = function (result) {
            if (!result.error) {
                firebase.update('/OtherTaskDetails/' + devicePhoneNumber + '/' + tappedItemKey, {
                    'remainderCount': result.value + 1,
                }).then(function (res) {
                }, function (res) { });
            }
        };
        firebase.query(onQueryEvent, '/OtherTaskDetails/' + devicePhoneNumber + '/' + tappedItemKey + '/remainderCount', {
            singleEvent: true,
            orderBy: {
                type: firebase.QueryOrderByType.KEY,
            },
        });
        timerModule.setTimeout(function () {
            x.dataItems = x.listViewItems.getOtherTaskDetails();
            x.showDetailedView = "collapse";
        }, 500);
    };
    OtherTaskComponent.prototype.itemTap = function (item) {
        console.log("ITem Key==" + item.key);
        this.tappedItemKey = item.key;
        console.log("tappedItemKey===" + this.tappedItemKey);
        this.detailedDataItems = this.listViewItems.getOtherTaskDetailsDetailedDetails(item.key);
        this.showDetailedView = "visible";
    };
    OtherTaskComponent.prototype.createTask = function () {
        this.router.navigate(["/createtask"]);
    };
    return OtherTaskComponent;
}());
OtherTaskComponent = __decorate([
    core_1.Component({
        selector: "my-app",
        providers: [http_post_services_1.MyHttpPostService],
        templateUrl: "pages/othertask/othertask.html",
        styleUrls: ["pages/othertask/othertask-common.css", "pages/othertask/othertask.css"]
    }),
    __metadata("design:paramtypes", [router_1.Router, page_1.Page, http_post_services_1.MyHttpPostService])
], OtherTaskComponent);
exports.OtherTaskComponent = OtherTaskComponent;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoib3RoZXJ0YXNrLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIm90aGVydGFzay5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSwwQ0FBeUM7QUFDekMsc0NBQWtEO0FBQ2xELDJFQUF5RTtBQUt6RSw2REFBNEQ7QUFFNUQsb0RBQXVEO0FBQ3ZELHVEQUEwRDtBQUMxRCw2REFVOEI7QUFDOUIsZ0NBQStCO0FBQy9CLHVFQUFxRTtBQVNyRSxJQUFhLGtCQUFrQjtJQVczQiw0QkFBb0IsTUFBYyxFQUFTLElBQVUsRUFBUyxhQUFnQztRQUE5RixpQkFZQztRQVptQixXQUFNLEdBQU4sTUFBTSxDQUFRO1FBQVMsU0FBSSxHQUFKLElBQUksQ0FBTTtRQUFTLGtCQUFhLEdBQWIsYUFBYSxDQUFtQjtRQVQ5RixjQUFTLEdBQUMsSUFBSSxrQ0FBZSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQ2xDLHNCQUFpQixHQUFFLElBQUksa0NBQWUsQ0FBQyxFQUFFLENBQUMsQ0FBQztRQVN2QyxJQUFJLENBQUMsYUFBYSxHQUFDLElBQUksNkJBQWEsQ0FBQztRQUNyQyxJQUFJLENBQUMsZ0JBQWdCLEdBQUMsVUFBVSxDQUFDO1FBQ2pDLElBQUksQ0FBQyxTQUFTLEdBQUMsWUFBWSxDQUFDO1FBQzVCLFFBQVEsQ0FBQyxtQkFBbUIsRUFBRSxDQUFDLElBQUksQ0FBQyxVQUFDLEtBQWE7WUFDOUMsK0JBQStCO1lBQ2hDLHlDQUF5QztZQUN4QyxLQUFJLENBQUMsV0FBVyxHQUFDLEtBQUssQ0FBQztRQUd6QixDQUFDLENBQUMsQ0FBQztJQUVULENBQUM7SUFFRCxxQ0FBUSxHQUFSO1FBRUksSUFBSSxDQUFDLFNBQVMsR0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLG1CQUFtQixFQUFFLENBQUM7SUFDNUQsQ0FBQztJQUNNLCtDQUFrQixHQUF6QixVQUEwQixJQUF1QjtRQUU3QyxJQUFJLFdBQVcsR0FBRyxJQUFJLENBQUMsSUFBSSxD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QUFDLGFBQWEsQ0FBQyxDQUFDLENBQUM7SUFFOUMsQ0FBQztJQUVMLHlCQUFDO0FBQUQsQ0FBQyxBQTNURCxJQTJUQztBQTNUWSxrQkFBa0I7SUFOOUIsZ0JBQVMsQ0FBQztRQUNULFFBQVEsRUFBRSxRQUFRO1FBQ2xCLFNBQVMsRUFBRSxDQUFDLHNDQUFpQixDQUFDO1FBQzlCLFdBQVcsRUFBRSxnQ0FBZ0M7UUFDN0MsU0FBUyxFQUFFLENBQUMsc0NBQXNDLEVBQUUsK0JBQStCLENBQUM7S0FDckYsQ0FBQztxQ0FZOEIsZUFBTSxFQUFlLFdBQUksRUFBd0Isc0NBQWlCO0dBWHJGLGtCQUFrQixDQTJUOUI7QUEzVFksZ0RBQWtCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgUm91dGVyIH0gZnJvbSBcIkBhbmd1bGFyL3JvdXRlclwiO1xuaW1wb3J0IHsgQ29tcG9uZW50LCBPbkluaXQgfSBmcm9tIFwiQGFuZ3VsYXIvY29yZVwiO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZUFycmF5IH0gZnJvbSBcInRucy1jb3JlLW1vZHVsZXMvZGF0YS9vYnNlcnZhYmxlLWFycmF5XCI7XG5pbXBvcnQgeyBEYXRhSXRlbSB9IGZyb20gXCIuLi8uLi9zZXJ2aWNlL2RhdGFJdGVtXCI7XG5pbXBvcnQgeyBEYXRhSXRlbVNlcnZpY2UgfSBmcm9tIFwiLi4vLi4vc2VydmljZS9kYXRhSXRlbS5zZXJ2aWNlXCI7XG5pbXBvcnQgeyBMaXN0Vmlld0V2ZW50RGF0YSwgUmFkTGlzdFZpZXcgfSBmcm9tIFwibmF0aXZlc2NyaXB0LXRlbGVyaWstdWktcHJvL2xpc3R2aWV3XCI7XG5pbXBvcnQgeyBWaWV3IH0gZnJvbSBcInRucy1jb3JlLW1vZHVsZXMvdWkvY29yZS92aWV3XCI7XG5pbXBvcnQgeyBMaXN0Vmlld0l0ZW1zIH0gZnJvbSBcIi4uLy4uL3NlcnZpY2UvbGlzdHZpZXdpdGVtc1wiO1xuaW1wb3J0IHsgUmFkTGlzdFZpZXdDb21wb25lbnQgfSBmcm9tIFwibmF0aXZlc2NyaXB0LXRlbGVyaWstdWktcHJvL2xpc3R2aWV3L2FuZ3VsYXJcIjtcbmltcG9ydCAqIGFzIHRpbWVyTW9kdWxlICBmcm9tIFwidG5zLWNvcmUtbW9kdWxlcy90aW1lclwiO1xuaW1wb3J0IGZpcmViYXNlID0gcmVxdWlyZShcIm5hdGl2ZXNjcmlwdC1wbHVnaW4tZmlyZWJhc2VcIik7XG5pbXBvcnQge1xuICAgIGdldEJvb2xlYW4sXG4gICAgc2V0Qm9vbGVhbixcbiAgICBnZXROdW1iZXIsXG4gICAgc2V0TnVtYmVyLFxuICAgIGdldFN0cmluZyxcbiAgICBzZXRTdHJpbmcsXG4gICAgaGFzS2V5LFxuICAgIHJlbW92ZSxcbiAgICBjbGVhclxufSBmcm9tIFwiYXBwbGljYXRpb24tc2V0dGluZ3NcIjtcbmltcG9ydCB7IFBhZ2UgfSBmcm9tIFwidWkvcGFnZVwiO1xuaW1wb3J0IHsgTXlIdHRwUG9zdFNlcnZpY2UgfSBmcm9tIFwiLi4vLi4vc2VydmljZS9odHRwLXBvc3Quc2VydmljZXNcIjtcblxuXG5AQ29tcG9uZW50KHtcbiAgc2VsZWN0b3I6IFwibXktYXBwXCIsXG4gIHByb3ZpZGVyczogW015SHR0cFBvc3RTZXJ2aWNlXSxcbiAgdGVtcGxhdGVVcmw6IFwicGFnZXMvb3RoZXJ0YXNrL290aGVydGFzay5odG1sXCIsXG4gIHN0eWxlVXJsczogW1wicGFnZXMvb3RoZXJ0YXNrL290aGVydGFzay1jb21tb24uY3NzXCIsIFwicGFnZXMvb3RoZXJ0YXNrL290aGVydGFzay5jc3NcIl1cbn0pXG5leHBvcnQgY2xhc3MgT3RoZXJUYXNrQ29tcG9uZW50IGltcGxlbWVudHMgT25Jbml0XG57XG4gICAgZGF0YUl0ZW1zPW5ldyBPYnNlcnZhYmxlQXJyYXkoW10pO1xuICAgIGRldGFpbGVkRGF0YUl0ZW1zPSBuZXcgT2JzZXJ2YWJsZUFycmF5KFtdKTtcbiAgICBsaXN0Vmlld0l0ZW1zOkxpc3RWaWV3SXRlbXM7XG4gICAgdGFwcGVkSXRlbUtleTtcbiAgICBcbiAgICBwYWdlVGl0bGU7XG4gICBcbiAgICBzaG93RGV0YWlsZWRWaWV3O1xuICAgIGRldmljZUZDTUlkO1xuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgcm91dGVyOiBSb3V0ZXIscHJpdmF0ZSBwYWdlOiBQYWdlLHByaXZhdGUgbXlQb3N0U2VydmljZTogTXlIdHRwUG9zdFNlcnZpY2UpIHtcbiAgICAgICAgdGhpcy5saXN0Vmlld0l0ZW1zPW5ldyBMaXN0Vmlld0l0ZW1zO1xuICAgICAgICB0aGlzLnNob3dEZXRhaWxlZFZpZXc9XCJjb2xsYXBzZVwiO1xuICAgICAgICB0aGlzLnBhZ2VUaXRsZT1cIk90aGVyIFRhc2tcIjtcbiAgICAgICAgZmlyZWJhc2UuZ2V0Q3VycmVudFB1c2hUb2tlbigpLnRoZW4oKHRva2VuOiBzdHJpbmcpID0+IHtcbiAgICAgICAgICAgIC8vIG1heSBiZSBudWxsIGlmIG5vdCBrbm93biB5ZXRcbiAgICAgICAgICAgLy8gYWxlcnQoXCJDdXJyZW50IHB1c2ggdG9rZW46IFwiICsgdG9rZW4pO1xuICAgICAgICAgICAgdGhpcy5kZXZpY2VGQ01JZD10b2tlbjtcbiAgICAgICAgICBcblxuICAgICAgICAgIH0pO1xuICAgICAgICBcbiAgICB9XG5cbiAgICBuZ09uSW5pdCgpIFxuICAgIHtcbiAgICAgICAgdGhpcy5kYXRhSXRlbXM9dGhpcy5saXN0Vmlld0l0ZW1zLmdldE90aGVyVGFza0RldGFpbHMoKTsgIFxuICAgIH1cbiAgICBwdWJsaWMgb25Td2lwZUNlbGxTdGFydGVkKGFyZ3M6IExpc3RWaWV3RXZlbnREYXRhKVxuICAgIHtcbiAgICAgICAgdmFyIHN3aXBlTGltaXRzID0gYXJncy5kYXRhLnN3aXBlTGltaXRzO1xuICAgICAgICB2YXIgc3dpcGVWaWV3ID0gYXJnc1snb2JqZWN0J107XG4gICAgICAgIHZhciBsZWZ0SXRlbSA9IHN3aXBlVmlldy5nZXRWaWV3QnlJZDxWaWV3PignZW1wdHlWaWV3Jyk7XG4gICAgICAgIHZhciByaWdodEl0ZW0gPSBzd2lwZVZpZXcuZ2V0Vmlld0J5SWQ8Vmlldz4oJ2RlbGV0ZVZpZXcnKTtcbiAgICAgICAgLy9zd2lwZUxpbWl0cy5sZWZ0ID0gbGVmdEl0ZW0uZ2V0TWVhc3VyZWRXaWR0aCgpO1xuICAgICAgICBzd2lwZUxpbWl0cy5sZWZ0ID0gMDtcbiAgICAgICAgc3dpcGVMaW1pdHMucmlnaHQgPSByaWdodEl0ZW0uZ2V0TWVhc3VyZWRXaWR0aCgpO1xuICAgICAgIC8vIHN3aXBlTGltaXRzLnJpZ2h0ID0gMDtcbiAgICAgICAgc3dpcGVMaW1pdHMudGhyZXNob2xkID0gbGVmdEl0ZW0uZ2V0TWVhc3VyZWRXaWR0aCgpIC8gMjtcbiAgICB9XG5cbiAgICBwdWJsaWMgb25QdWxsVG9SZWZyZXNoSW5pdGlhdGVkKGFyZ3M6IExpc3RWaWV3RXZlbnREYXRhKVxuICAgIHtcbiAgICAgICAgdGhpcy5kYXRhSXRlbXM9dGhpcy5saXN0Vmlld0l0ZW1zLmdldE90aGVyVGFza0RldGFpbHMoKTsgICAgXG4gICAgICAgIHRpbWVyTW9kdWxlLnNldFRpbWVvdXQoZnVuY3Rpb24gKClcbiAgICAgICAge1xuICAgICAgICAgICAgICAgIHZhciBsaXN0VmlldyA9IGFyZ3Mub2JqZWN0O1xuICAgICAgICAgICAgICAgIGxpc3RWaWV3Lm5vdGlmeVB1bGxUb1JlZnJlc2hGaW5pc2hlZCgpO1xuICAgICAgICAgICAgfSwxMDAwKTsgICAgXG5cbiAgIH1cbiAgIGRlbGV0ZVRhc2soYXJncylcbiAgIHtcbiAgICBcbiAgICAgICAgdmFyIHRhcEluZGV4PXRoaXMuZGF0YUl0ZW1zLmluZGV4T2YoYXJncy5vYmplY3QuYmluZGluZ0NvbnRleHQpXG5cbiAgICAgICAgY29uc29sZS5sb2coXCJJdGVtIEtheT09PT09PVwiK3RoaXMuZGF0YUl0ZW1zLmdldEl0ZW0odGFwSW5kZXgpLmtleSk7XG4gICAgICAgIGNvbnNvbGUubG9nKFwiVGFzayBOYW1lPT09PT09XCIrdGhpcy5kYXRhSXRlbXMuZ2V0SXRlbSh0YXBJbmRleCkudGFza05hbWUpO1xuICAgICAgICB2YXIgY3JlYXRlZEJ5TnVtYmVyPXRoaXMuZGF0YUl0ZW1zLmdldEl0ZW0odGFwSW5kZXgpLmNyZWF0ZWRCeU51bWJlcjtcbiAgICAgICAgLy92YXIga2V5PXRoaXMuZGF0YUl0ZW1zLmdldEl0ZW0odGFwSW5kZXgpLmtleTtcbiAgICAgICAgdmFyIGl0ZW1LZXk9dGhpcy5kYXRhSXRlbXMuZ2V0SXRlbSh0YXBJbmRleCkua2V5O1xuICAgICAgICB2YXIgZGV2aWNlUGhvbmVOdW1iZXI9Z2V0U3RyaW5nKFwiZGV2aWNlUGhvbmVOdW1iZXJcIik7XG5cbiAgICAgICAgdmFyIHg9dGhpcztcbiAgICAgICAgdmFyIG9uUXVlcnlFdmVudD1mdW5jdGlvbihyZXN1bHQpXG4gICAgICAgIHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiRGVsZXRlIE15IHRhc2tcIik7XG4gICAgICAgICAgICBpZiAoIXJlc3VsdC5lcnJvcilcbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcIklGXCIpO1xuICAgICAgICAgICAgICAgIHZhciByZXN1bHRKc29uPXJlc3VsdC52YWx1ZTtcbiAgICAgICAgICAgICAgICBsZXQgYXNzaWduZWVEZXZpY2VUb2tlbjtcbiAgICAgICAgICAgICAgICBsZXQgdGFza05hbWU7XG4gICAgICAgICAgICAgICAgbGV0IGNyZWF0ZWRCeU5hbWU7XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCJSZXN1bHQ9PVwiK3Jlc3VsdEpzb24pO1xuICAgICAgICAgICAgICAgIGZvcih2YXIga2V5MSBpbiByZXN1bHRKc29uKVxuICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCJBc3NpZ25lZSBOdW1iZXJcIitrZXkxKTtcbiAgICAgICAgICAgICAgICAgICAgaWYoa2V5MT09bnVsbCB8fCBrZXkxPT1cIm51bGxcIil7fVxuICAgICAgICAgICAgICAgICAgICBlbHNlXG4gICAgICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vYXNzaWduZWVEZXZpY2VUb2tlbj1yZXN1bHRKc29uW2tleTFdW1wiZGV2aWNlVG9rZW5cIl07XG4gICAgICAgICAgICAgICAgICAgICAgICAvL3Rhc2tOYW1lPXJlc3VsdEpzb25ba2V5MV1bXCJ0YXNrTmFtZVwiXTtcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vY3JlYXRlZEJ5TmFtZT1yZXN1bHRKc29uW2tleTFdW1wiY3JlYXRlZEJ5XCJdO1xuICAgICAgICAgICAgICAgICAgICAgICAgLy9jb25zb2xlLmxvZyhcImFzc2lnbmVlRGV2aWNlVG9rZW49PT09XCIrYXNzaWduZWVEZXZpY2VUb2tlbik7XG4gICAgICAgICAgICAgICAgICAgICAgICAvL2RlbGV0ZSB0aGUgdGFzayBpbiBteSB0YXNrIGRldGFpbHNcbiAgICAgICAgICAgICAgICAgICAgICAgIGZpcmViYXNlLnJlbW92ZShcbiAgICAgICAgICAgICAgICAgICAgICAgICcvTXlUYXNrRGV0YWlscy8nK2tleTErJy8nK2l0ZW1LZXksXG4gICAgICAgICAgICAgICAgICAgICAgICApLnRoZW4oXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgKHJlcyk9PntcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiVGFzayBoYXMgYmVlbiBkZWxldGVkIHN1Y2Nlc3NmdWxseSBpbiBNeSB0YXNrIGRldGFpbHMtLS1cIik7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHguc2VuZFB1c2hOb3RpZmljYXRpb25Gb3JEZWxldGlvbihhc3NpZ25lZURldmljZVRva2VuLHRhc2tOYW1lLGNyZWF0ZWRCeU5hbWUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sKHJlcyk9PntcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiUHJvYmxlbSBpbiBkZWxldGluZyBNeSB0YXNrIGRldGFpbHMtLS1cIityZXMpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuXG5cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICB9ICBcblxuICAgICAgICAgICAgICAgIHguZGVsZXRlT3RoZXJUYXNrKGRldmljZVBob25lTnVtYmVyLHRhcEluZGV4LGl0ZW1LZXkpO1xuICAgICAgICAgICAgICAgIGZvcih2YXIga2V5MSBpbiByZXN1bHRKc29uKVxuICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIGlmKGtleTE9PW51bGwgfHwga2V5MT09XCJudWxsXCIpe31cbiAgICAgICAgICAgICAgICAgICAgZWxzZVxuICAgICAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgICAgICBhc3NpZ25lZURldmljZVRva2VuPXJlc3VsdEpzb25ba2V5MV1bXCJkZXZpY2VUb2tlblwiXTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRhc2tOYW1lPXJlc3VsdEpzb25ba2V5MV1bXCJ0YXNrTmFtZVwiXTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNyZWF0ZWRCeU5hbWU9cmVzdWx0SnNvbltrZXkxXVtcImNyZWF0ZWRCeVwiXTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiYXNzaWduZWVEZXZpY2VUb2tlbj09PT1cIithc3NpZ25lZURldmljZVRva2VuKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHguc2VuZFB1c2hOb3RpZmljYXRpb25Gb3JEZWxldGlvbihhc3NpZ25lZURldmljZVRva2VuLHRhc2tOYW1lLGNyZWF0ZWRCeU5hbWUpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIH0gIFxuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgICBcbiAgICAgICAgfSAgIFxuICAgICAgICBmaXJlYmFzZS5xdWVyeShcbiAgICAgICAgICBvblF1ZXJ5RXZlbnQsXG4gICAgICAgICcvT3RoZXJUYXNrRGV0YWlscy8nK2RldmljZVBob25lTnVtYmVyKycvJytpdGVtS2V5KycvQXNzaWduZWVEZXRhaWxzJyxcbiAgICAgICAgICB7XG4gICAgICAgICAgICAgIFxuICAgICAgICAgICAgICBzaW5nbGVFdmVudDogdHJ1ZSxcbiAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgIG9yZGVyQnk6IHtcbiAgICAgICAgICAgICAgICAgIHR5cGU6IGZpcmViYXNlLlF1ZXJ5T3JkZXJCeVR5cGUuS0VZLFxuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICBcbiAgICAgICAgICB9XG4gICAgICAgICk7XG4gICAgICAgIHRpbWVyTW9kdWxlLnNldFRpbWVvdXQoZnVuY3Rpb24gKClcbiAgICAgICAge1xuXG4gICAgICAgICAgICAgICB4LmRhdGFJdGVtcz14Lmxpc3RWaWV3SXRlbXMuZ2V0T3RoZXJUYXNrRGV0YWlscygpO1xuICAgICAgICB9LDEwMDApO1xuICAgICAgICBcblxuXG4gICAgICAgIFxuICAgICAgIFxuICAgfVxuICAgcHVibGljIGRlbGV0ZU90aGVyVGFzayhkZXZpY2VQaG9uZU51bWJlcix0YXBJbmRleCxpdGVtS2V5KVxuICAgIHtcbiAgICAgICAgICAgICAgICAvL2RlbGV0ZSB0YXNrIGluIG90aGVyIHRhc2sgZGV0YWlscyBwYWdlXG4gICAgICAgICAgICAgICAgIGZpcmViYXNlLnJlbW92ZShcbiAgICAgICAgICAgICAgICAnL090aGVyVGFza0RldGFpbHMvJytkZXZpY2VQaG9uZU51bWJlcisnLycraXRlbUtleSxcbiAgICAgICAgICAgICAgICApLnRoZW4oXG4gICAgICAgICAgICAgICAgICAocmVzKT0+e1xuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcIlRhc2sgaGFzIGJlZW4gZGVsZXRlZCBzdWNjZXNzZnVsbHkgaW4gb3RoZXIgdGFzayBkZXRhaWxzLS0tXCIpO1xuICAgICAgICAgICAgICAgICAgfSwocmVzKT0+e1xuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcIlByb2JsZW0gaW4gZGVsZXRpbmcgb3RoZXIgdGFzayBkZXRhaWxzLS0tXCIrcmVzKTtcbiAgICAgICAgICAgICAgICAgIH0pO1xuICAgIH0gXG4gICAgICBcbiAgICBjYW5jZWwoKVxuICAgIHtcbiAgICAgICAgdGhpcy5zaG93RGV0YWlsZWRWaWV3PVwiY29sbGFwc2VcIjsgICAgXG4gICAgfVxuXG4gICAgXG5cbiAgICBwdWJsaWMgZ2V0UmVtYWluZGVyQ291bnRBbmRVcGRhdGUobnVtYmVyLGNTdGF0dXMsckNvdW50KVxuICAgIHtcbiAgICAgICAgdmFyIGRldmljZVBob25lTnVtYmVyPWdldFN0cmluZyhcImRldmljZVBob25lTnVtYmVyXCIpO1xuICAgICAgICBmaXJlYmFzZS51cGRhdGUoXG4gICAgICAgICcvTXlUYXNrRGV0YWlscy8nK251bWJlcisnLycrdGhpcy50YXBwZWRJdGVtS2V5LFxuICAgICAgICB7XG4gICAgICAgICAgICAncmVtYWluZGVyQ291bnQnOnJDb3VudCsxLFxuICAgICAgICB9XG4gICAgICAgICk7XG4gICAgICAgIGZpcmViYXNlLnVwZGF0ZShcbiAgICAgICAgJy9PdGhlclRhc2tEZXRhaWxzLycrZGV2aWNlUGhvbmVOdW1iZXIrJy8nK3RoaXMudGFwcGVkSXRlbUtleSsnL0Fzc2lnbmVlRGV0YWlscy8nK251bWJlcixcbiAgICAgICAge1xuICAgICAgICAgICAgJ3JlbWFpbmRlckNvdW50JzpyQ291bnQrMSxcbiAgICAgICAgfVxuICAgICAgICApO1xuICAgIH1cbiAgICBzZW5kUHVzaE5vdGlmaWNhdGlvbihkZXZpY2VUb2tlbix0YXNrTmFtZSxjcmVhdGVkQnlOYW1lKXtcbiAgICAgICAgXG4gICAgICAgIC8vc2VuZCBwdXNoIG5vdGlmaWNhdGlvblxuICAgICAgICBsZXQgZGF0YT17XG4gICAgICAgICAgICBcIm5vdGlmaWNhdGlvblwiOiB7XG4gICAgICAgICAgICAgICAgXCJ0aXRsZVwiOiBcIlJlbWluZGVyIVwiLFxuICAgICAgICAgICAgICAgIFwiYm9keVwiOiBcIlJlbWluZGVyIHNlbnQgYnkgXCIrY3JlYXRlZEJ5TmFtZStcIiBmb3IgXCIrdGFza05hbWUsXG4gICAgICAgICAgICAgICAgXCJwcmlvcml0eVwiOiBcImhpZ2hcIlxuICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICBcInRvXCI6ZGV2aWNlVG9rZW5cbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhcImRhdGE9PVwiK0pTT04uc3RyaW5naWZ5KGRhdGEpKTtcbiAgICAgICAgdGhpcy5teVBvc3RTZXJ2aWNlXG4gICAgICAgIC5wb3N0RGF0YShkYXRhKS5zdWJzY3JpYmUoKHJlcyk9PntcbiAgXG4gICAgICAgICAgICBjb25zb2xlLmxvZyhcIlJlbWluZGVyIFN1Y2Nlc3NcIik7XG4gICAgICAgIH0sKGVycm9yKT0+e1xuICAgICAgICAgICAgY29uc29sZS5sb2coXCJSZW1pbmRlciBGYWlsdXJlPT09XCIrZXJyb3IpO1xuICAgICAgICB9KTtcbiAgICB9XG4gICAgc2VuZFB1c2hOb3RpZmljYXRpb25Gb3JEZWxldGlvbihhc3NpZ25lZURldmljZVRva2VuLHRhc2tOYW1lLGNyZWF0ZWRCeU5hbWUpXG4gICAge1xuICAgICAgICBcbiAgICAgICAgLy9zZW5kIHB1c2ggbm90aWZpY2F0aW9uXG4gICAgICAgIGxldCBkYXRhPXtcbiAgICAgICAgICAgIFwibm90aWZpY2F0aW9uXCI6IHtcbiAgICAgICAgICAgICAgICBcInRpdGxlXCI6IFwiVGFzayBSZW1vdmVkIVwiLFxuICAgICAgICAgICAgICAgIFwiYm9keVwiOiBjcmVhdGVkQnlOYW1lK1wiIGhhcyByZW1vdmVkIHRoZSBcIit0YXNrTmFtZSxcbiAgICAgICAgICAgICAgICBcInByaW9yaXR5XCI6IFwiaGlnaFwiXG4gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgIFwidG9cIjphc3NpZ25lZURldmljZVRva2VuXG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgY29uc29sZS5sb2coXCJkYXRhPT1cIitKU09OLnN0cmluZ2lmeShkYXRhKSk7XG4gICAgICAgIHRoaXMubXlQb3N0U2VydmljZVxuICAgICAgICAucG9zdERhdGEoZGF0YSkuc3Vic2NyaWJlKChyZXMpPT57XG4gIFxuICAgICAgICAgICAgY29uc29sZS5sb2coXCJSZW1pbmRlciBTdWNjZXNzXCIpO1xuICAgICAgICB9LChlcnJvcik9PntcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiUmVtaW5kZXIgRmFpbHVyZT09PVwiK2Vycm9yKTtcbiAgICAgICAgfSk7XG4gICAgfVxuICAgIHNlbmRSZW1pbmRlcigpXG4gICAge1xuICAgICAgICBcbiAgICAgICAgY29uc29sZS5sb2coXCJ0YXBwZWRJdGVtS2V5PT09XCIrdGhpcy50YXBwZWRJdGVtS2V5KTsgXG4gICAgICAgIGxldCB0YXBwZWRJdGVtS2V5PXRoaXMudGFwcGVkSXRlbUtleTtcbiAgICAgICAgbGV0IHJlbWluZGVyU2VuZERldGFpbHM9bmV3IE9ic2VydmFibGVBcnJheShbXSk7XG4gICAgICAgICB2YXIgeD10aGlzO1xuICAgICAgICB2YXIgZGV2aWNlUGhvbmVOdW1iZXI9Z2V0U3RyaW5nKFwiZGV2aWNlUGhvbmVOdW1iZXJcIik7XG4gICAgICAgICBjb25zb2xlLmxvZyhcIkxlbmd0aD09PVwiK3RoaXMuZGV0YWlsZWREYXRhSXRlbXMubGVuZ3RoKTtcbiAgICAgICAgZm9yKHZhciBpPTA7aTx0aGlzLmRldGFpbGVkRGF0YUl0ZW1zLmxlbmd0aDtpKyspXG4gICAgICAgIHtcbiAgICAgICAgICAgXG4gICAgICAgICAgIFxuICAgICAgICAgICAgdmFyIG51bWJlcj10aGlzLmRldGFpbGVkRGF0YUl0ZW1zLmdldEl0ZW0oaSkuYXNzaWduZWVOdW1iZXI7XG4gICAgICAgICAgICB2YXIgY1N0YXR1cz10aGlzLmRldGFpbGVkRGF0YUl0ZW1zLmdldEl0ZW0oaSkuY29tcGxldGlvblN0YXR1cztcbiAgICAgICAgICAgIHZhciByQ291bnQ9dGhpcy5kZXRhaWxlZERhdGFJdGVtcy5nZXRJdGVtKGkpLnJlbWFpbmRlckNvdW50O1xuICAgICAgICAgICAgbGV0IGRldmljZVRva2VuPXRoaXMuZGV0YWlsZWREYXRhSXRlbXMuZ2V0SXRlbShpKS5kZXZpY2VUb2tlbjtcbiAgICAgICAgICAgIGxldCB0YXNrTmFtZT10aGlzLmRldGFpbGVkRGF0YUl0ZW1zLmdldEl0ZW0oaSkudGFza05hbWU7XG4gICAgICAgICAgICBsZXQgY3JlYXRlZEJ5TmFtZT10aGlzLmRldGFpbGVkRGF0YUl0ZW1zLmdldEl0ZW0oaSkuY3JlYXRlZEJ5O1xuICAgICAgICAgICAgY29uc29sZS5sb2coXCJOdW1iZXI9PT09XCIrbnVtYmVyKTtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiY1N0YXR1cz09PT1cIitjU3RhdHVzKTtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwickNvdW50PT09PVwiK3JDb3VudCk7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhcIkRldmljZSBUb2tlbj09PT1cIitkZXZpY2VUb2tlbik7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhcIlRhc2sgTmFtZT09PT1cIit0YXNrTmFtZSk7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhcIkNyZWF0ZWQgQnk9PT09XCIrY3JlYXRlZEJ5TmFtZSk7XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIGlmKCFjU3RhdHVzKVxuICAgICAgICAgICAgdGhpcy5nZXRSZW1haW5kZXJDb3VudEFuZFVwZGF0ZShudW1iZXIsY1N0YXR1cyxyQ291bnQpO1xuICAgICAgICAgICAgdGhpcy5zZW5kUHVzaE5vdGlmaWNhdGlvbihkZXZpY2VUb2tlbix0YXNrTmFtZSxjcmVhdGVkQnlOYW1lKTtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgXG4gICAgICAgICAgICBcbiAgICAgICAgfVxuXG4gICAgICAgIHZhciBvblF1ZXJ5RXZlbnQ9ZnVuY3Rpb24ocmVzdWx0KXtcbiAgICAgICAgICAgIGlmKCFyZXN1bHQuZXJyb3IpXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgZmlyZWJhc2UudXBkYXRlKFxuICAgICAgICAgICAgICAgICcvT3RoZXJUYXNrRGV0YWlscy8nK2RldmljZVBob25lTnVtYmVyKycvJyt0YXBwZWRJdGVtS2V5LFxuICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgJ3JlbWFpbmRlckNvdW50JzpyZXN1bHQudmFsdWUrMSxcbiAgICAgICAgICAgICAgICB9KS50aGVuKChyZXMpPT57XG4gICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIH0sKHJlcyk9Pnt9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBmaXJlYmFzZS5xdWVyeShcbiAgICAgICAgICBvblF1ZXJ5RXZlbnQsXG4gICAgICAgICcvT3RoZXJUYXNrRGV0YWlscy8nK2RldmljZVBob25lTnVtYmVyKycvJyt0YXBwZWRJdGVtS2V5KycvcmVtYWluZGVyQ291bnQnLFxuICAgICAgICAgIHtcbiAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgIHNpbmdsZUV2ZW50OiB0cnVlLFxuICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgb3JkZXJCeToge1xuICAgICAgICAgICAgICAgICAgdHlwZTogZmlyZWJhc2UuUXVlcnlPcmRlckJ5VHlwZS5LRVksXG4gICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgIFxuICAgICAgICAgIH1cbiAgICAgICAgKTtcbiAgICAgICAgdGltZXJNb2R1bGUuc2V0VGltZW91dChmdW5jdGlvbiAoKVxuICAgICAgICB7XG4gICAgICAgICAgICB4LmRhdGFJdGVtcz14Lmxpc3RWaWV3SXRlbXMuZ2V0T3RoZXJUYXNrRGV0YWlscygpO1xuICAgICAgICAgICAgeC5zaG93RGV0YWlsZWRWaWV3PVwiY29sbGFwc2VcIjsgXG4gICAgICAgIH0sNTAwKTtcbiAgICAgICAgXG5cbiAgICAgICAgXG4gICAgICAgIFxuICAgICAgIFxuXG5cbiAgICB9XG4gICAgaXRlbVRhcChpdGVtKVxuICAgIHtcbiAgICAgICAgXG4gICAgICAgIGNvbnNvbGUubG9nKFwiSVRlbSBLZXk9PVwiK2l0ZW0ua2V5KTtcbiAgICAgICAgdGhpcy50YXBwZWRJdGVtS2V5PWl0ZW0ua2V5O1xuICAgICAgICBjb25zb2xlLmxvZyhcInRhcHBlZEl0ZW1LZXk9PT1cIit0aGlzLnRhcHBlZEl0ZW1LZXkpO1xuICAgICAgICBcbiAgICAgICAgdGhpcy5kZXRhaWxlZERhdGFJdGVtcz10aGlzLmxpc3RWaWV3SXRlbXMuZ2V0T3RoZXJUYXNrRGV0YWlsc0RldGFpbGVkRGV0YWlscyhpdGVtLmtleSk7XG4gICAgICAgIFxuICAgICAgICB0aGlzLnNob3dEZXRhaWxlZFZpZXc9XCJ2aXNpYmxlXCI7XG4gICAgXG4gICAgfVxuXG4gICAgY3JlYXRlVGFzaygpe1xuICAgICAgICAgICAgdGhpcy5yb3V0ZXIubmF2aWdhdGUoW1wiL2NyZWF0ZXRhc2tcIl0pO1xuXG4gICAgfVxuICAgXG59XG5cblxuXG4iXX0=